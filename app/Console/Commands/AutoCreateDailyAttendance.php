<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use App\Filament\Pages\PresensiKelas;
use Carbon\Carbon;

class AutoCreateDailyAttendance extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'attendance:auto-create {tanggal?}';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'Membuat presensi otomatis untuk tanggal kemarin jika belum ada';

    /**
     * Execute the console command.
     *
     * @return int
     */
    public function handle()
    {
        // Set locale ke Indonesia
        Carbon::setLocale('id');

        $tanggal = $this->argument('tanggal') ?: Carbon::yesterday()->format('Y-m-d');
        $tanggalFormatted = Carbon::parse($tanggal)->translatedFormat('l, d F Y');

        $this->info("========================================");
        $this->info("      SISTEM PRESENSI OTOMATIS");
        $this->info("========================================");
        $this->info("ğŸ“… Memproses tanggal: {$tanggalFormatted}");
        $this->info("ğŸ• Waktu eksekusi: " . now()->translatedFormat('l, d F Y H:i:s'));
        $this->info("");

        try {
            // Tampilkan informasi hari
            $this->showDayInfo($tanggal);

            // Proses pembuatan presensi
            $result = PresensiKelas::autoGenerateDailyAttendance($tanggal);

            if ($result) {
                $this->displaySuccessMessage($tanggal);
            } else {
                $this->displaySkippedMessage($tanggal);
            }

            // Tampilkan statistik
            $this->showStatistics($tanggal);
        } catch (\Exception $e) {
            $this->displayErrorMessage($e);
            return Command::FAILURE;
        }

        $this->info("");
        $this->info("========================================");
        $this->info("âœ¨ Proses selesai pada: " . now()->translatedFormat('H:i:s'));
        $this->info("========================================");

        return Command::SUCCESS;
    }

    /**
     * Tampilkan informasi hari
     */
    private function showDayInfo($tanggal)
    {
        $carbonDate = Carbon::parse($tanggal);
        $today = Carbon::today();

        $this->info("ğŸ“Š INFORMASI HARI:");
        $this->info("   â€¢ Hari: " . $carbonDate->translatedFormat('l'));
        $this->info("   â€¢ Tanggal: " . $carbonDate->translatedFormat('d F Y'));

        if ($carbonDate->isToday()) {
            $this->warn("   â€¢ Status: Hari ini");
        } elseif ($carbonDate->isYesterday()) {
            $this->info("   â€¢ Status: Kemarin");
        } elseif ($carbonDate->isFuture()) {
            $this->warn("   â€¢ Status: Masa depan");
        } else {
            $daysDiff = $today->diffInDays($carbonDate);
            $this->info("   â€¢ Status: {$daysDiff} hari yang lalu");
        }

        // Cek apakah weekend
        if ($carbonDate->isWeekend()) {
            if ($carbonDate->isSaturday()) {
                $this->warn("   â€¢ Jenis: Hari Sabtu (Akhir Pekan)");
            } else {
                $this->warn("   â€¢ Jenis: Hari Minggu (Akhir Pekan)");
            }
        } else {
            $this->info("   â€¢ Jenis: Hari Sekolah");
        }

        $this->info("");
    }

    /**
     * Tampilkan pesan sukses
     */
    private function displaySuccessMessage($tanggal)
    {
        $this->info("ğŸ‰ BERHASIL MEMBUAT PRESENSI OTOMATIS!");
        $this->info("");
        $this->info("âœ… Semua siswa telah dibuatkan presensi");
        $this->info("âœ… Siswa dengan izin disetujui sudah ditandai sesuai jenis izin");
        $this->info("âœ… Siswa tanpa izin otomatis ditandai 'Hadir'");
        $this->info("âœ… Pertemuan ke-X sudah dihitung otomatis");
        $this->info("");

        // Tampilkan detail waktu pemrosesan
        $carbonDate = Carbon::parse($tanggal);
        if ($carbonDate->isYesterday()) {
            $this->comment("ğŸ’¡ Presensi kemarin berhasil dibuat secara otomatis");
        } elseif ($carbonDate->isPast()) {
            $daysDiff = Carbon::today()->diffInDays($carbonDate);
            $this->comment("ğŸ’¡ Presensi {$daysDiff} hari yang lalu berhasil dibuat");
        }
    }

    /**
     * Tampilkan pesan dilewati
     */
    private function displaySkippedMessage($tanggal)
    {
        $carbonDate = Carbon::parse($tanggal);

        $this->warn("âš ï¸  PRESENSI DILEWATI");
        $this->info("");

        if ($carbonDate->isWeekend()) {
            if ($carbonDate->isSaturday()) {
                $this->warn("ğŸ“… Alasan: Hari Sabtu (Akhir Pekan)");
                $this->info("   Tidak ada kegiatan pembelajaran pada hari Sabtu");
            } else {
                $this->warn("ğŸ“… Alasan: Hari Minggu (Akhir Pekan)");
                $this->info("   Tidak ada kegiatan pembelajaran pada hari Minggu");
            }
        } else {
            // Cek apakah hari libur
            $holiday = \App\Models\HariLibur::where('tanggal_mulai', '<=', $tanggal)
                ->where(function ($query) use ($tanggal) {
                    $query->whereNull('tanggal_selesai')
                        ->where('tanggal_mulai', '=', $tanggal)
                        ->orWhere('tanggal_selesai', '>=', $tanggal);
                })
                ->first();

            if ($holiday) {
                $this->warn("ğŸ–ï¸  Alasan: Hari Libur Resmi");
                $this->info("   Nama: " . $holiday->nama_hari_libur);
                if ($holiday->keterangan) {
                    $this->info("   Keterangan: " . $holiday->keterangan);
                }

                // Tampilkan rentang tanggal jika libur lebih dari 1 hari
                if ($holiday->tanggal_selesai && !$holiday->tanggal_mulai->equalTo($holiday->tanggal_selesai)) {
                    $this->info("   Periode: " . $holiday->tanggal_mulai->translatedFormat('d F Y') .
                        " - " . $holiday->tanggal_selesai->translatedFormat('d F Y'));
                }
            } else {
                $this->warn("â“ Alasan: Tidak diketahui (kemungkinan sudah ada presensi)");
            }
        }

        $this->info("");
        $this->comment("ğŸ’¡ Tidak ada record presensi yang dibuat untuk tanggal ini");
    }

    /**
     * Tampilkan pesan error
     */
    private function displayErrorMessage($exception)
    {
        $this->error("âŒ TERJADI KESALAHAN!");
        $this->error("");
        $this->error("ğŸ” Detail Error:");
        $this->error("   â€¢ Pesan: " . $exception->getMessage());
        $this->error("   â€¢ File: " . $exception->getFile());
        $this->error("   â€¢ Baris: " . $exception->getLine());
        $this->error("");
        $this->error("ğŸ“‹ Stack Trace:");
        $this->error($exception->getTraceAsString());
        $this->error("");
        $this->warn("ğŸ’¡ Silakan hubungi administrator sistem untuk mengatasi masalah ini.");
    }

    /**
     * Tampilkan statistik presensi
     */
    private function showStatistics($tanggal)
    {
        try {
            $this->info("ğŸ“ˆ STATISTIK PRESENSI:");

            // Hitung total kelas aktif
            $totalKelas = \App\Models\WaliKelas::whereHas('kelas')->count();
            $this->info("   â€¢ Total Kelas: {$totalKelas} kelas");

            // Hitung total siswa aktif
            $totalSiswa = \App\Models\Siswa::where('is_active', true)->count();
            $this->info("   â€¢ Total Siswa Aktif: {$totalSiswa} siswa");

            // Hitung presensi yang dibuat untuk tanggal ini
            $presensiHariIni = \App\Models\Presensi::where('tanggal_presensi', $tanggal)->count();
            $this->info("   â€¢ Presensi Tanggal Ini: {$presensiHariIni} record");

            // Hitung berdasarkan status
            $statusStats = \App\Models\Presensi::where('tanggal_presensi', $tanggal)
                ->selectRaw('status, COUNT(*) as jumlah')
                ->groupBy('status')
                ->get();

            if ($statusStats->count() > 0) {
                $this->info("   â€¢ Detail Status:");
                foreach ($statusStats as $stat) {
                    $icon = $this->getStatusIcon($stat->status);
                    $this->info("     {$icon} {$stat->status}: {$stat->jumlah} siswa");
                }
            }

            // Hitung siswa dengan izin disetujui
            $siswaIzin = \App\Models\Izin::where('status', 'Disetujui')
                ->where('tanggal_mulai', '<=', $tanggal)
                ->where('tanggal_selesai', '>=', $tanggal)
                ->count();

            if ($siswaIzin > 0) {
                $this->info("   â€¢ Siswa Berizin: {$siswaIzin} siswa");
            }

            $this->info("");
        } catch (\Exception $e) {
            $this->warn("âš ï¸  Tidak dapat menampilkan statistik: " . $e->getMessage());
        }
    }

    /**
     * Dapatkan icon berdasarkan status
     */
    private function getStatusIcon($status)
    {
        return match ($status) {
            'Hadir' => 'âœ…',
            'Izin' => 'ğŸ“‹',
            'Sakit' => 'ğŸ¤’',
            'Alpa' => 'âŒ',
            default => 'â“'
        };
    }
}
